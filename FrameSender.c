#include <stdio.h>
#include <errno.h>
#include "osdep/osdep.h"

static struct wif *_wi_in, *_wi_out;
unsigned long nb_pkt_sent;

int send_packet(void *buf, size_t count)
{
	struct wif *wi = _wi_out;
	unsigned char *pkt = (unsigned char*) buf;

	if( (count > 24) && (pkt[1] & 0x04) == 0 && (pkt[22] & 0x0F) == 0)
	{
		pkt[22] = (nb_pkt_sent & 0x0000000F) << 4;
		pkt[23] = (nb_pkt_sent & 0x00000FF0) >> 4;
	}

	if (wi_write(wi, buf, count, NULL) == -1) {
		switch (errno) {
		case EAGAIN:
		case ENOBUFS:
			usleep(10000);
			return 0;
		}

		perror("wi_write()");
		return -1;
	}

	nb_pkt_sent++;
	return 0;
}

int read_packet(void *buf, size_t count, struct rx_info *ri)
{
	struct wif *wi = _wi_in; /* XXX */
	int rc;

        rc = wi_read(wi, buf, count, ri);
        if (rc == -1) {
            switch (errno) {
            case EAGAIN:
                    return 0;
            }

            perror("wi_read()");
            return -1;
        }

	return rc;
}

int main( int argc, char *argv[] )
{
	nb_pkt_sent=0;
    printf("Start test\n");

	/* open the replay interface */
	_wi_out = wi_open(argv[1]);
	if (!_wi_out)
		return 1;

    char pack[] =
    {
		0x08,0x41, // Frame Type
		0x2c,0x00, // Duration
		0x74,0xea,0x3a,0xd7,0x98,0xf2, // STA Addr
		0xf0,0x27,0x65,0x7d,0xff,0xff, // BSSID
		0x74,0xea,0x3a,0xd7,0x98,0xf2, // SA
		0x30,0xa0, // Sequence number
		0x02,0x09,0x00,0x20,0x00,0x00,0x00,0x00, // Initialization vector

		// Data
		0x74,0xba,0xc9,0xf9,0x51,0x92,0x40,0x9d,0x06,0xee,0xe3,0xa8,0x5c,0xde,0x80,0x17,0x7a,0x2d,0xd7,0x4e,0xcb,0x53,0xb4,
		0x2d,0xa7,0x65,0x02,0x66,0xef,0x66,0xdd,0x91,0x7b,0x5c,0x5a,0x71,0x64,0xfa,0xe9,0xf2,0x5a,0xce,0xcd,0x93,0x3c,0xae,
		0x87,0x60,0xcf,0xdd,0xab,0x2f,0x54,0x40,0x3d,0x3a,0x05,0x7c,0xce,0x2a,0x21,0xa8,0x59,0xc5,0x0f,0xa4,0xde,0xe3,0xda,
		0x79,0xe1,0x1f,0x50,0x9f,0x2b,0x88,0xc0,0x79,0x36,0x97,0x51,0x4e,0x36,0xe2,0x16,0xf0,0xea,0x92,0xf6,0xe1,0xf8,0x37,
		0xed,0x4b,0x1e,0xba,0x01,0x8c,0x39,0x22,0x90,0x4d,0xc1,0x85,0xe2,0x39,0xb3,0xee,0x7c,0xea,0x44,0x96,0x08,0xda,0xd2,
		0xfb,0x35,0x7f,0x04,0x83,0xd2,0x13,0x3c,0x27,0x57,0xfc,0x91,0xf6,0xab,0xf4,0xdd,0xe2,0xe5,0x02,0xcf,0xb8,0x77,0xb4,
		0x86,0x1c,0xd1,0xe5,0x62,0xd1,0xf4,0x01,0x84,0xc9,0xb4,0x25,0xec,0x55,0x9f,0x01,0x5e,0x23,0xf2,0x0c,0x2d,0xd5,0xf3,
		0x37,0xe3,0xd7,0x2d,0xb8,0xf4,0x0c,0xe5,0x86,0xc5,0xeb,0x0c,0x99
    };
    
    for(int i =0; i<= 300; i++){
    send_packet(pack, sizeof(pack));
    printf("tick %d\n", i);
    usleep(1000000);
    }
    
    
    printf("Test is done. Packet length:%d sent.\n", sizeof(pack));

    return( 0 );
}

/*
0x80,0x00,0x00,0x00,0xff,0xff,0xff,0xff,0xff,0xff,
0x74,0xea,0x3a,0xd7,0x98,0xf2,0x74,0xea,0x3a,0xd7,
0x98,0xf2,0xf0,0xba,0x81,0xc1,0x9e,0xf4,0xae,0x02,
0x00,0x00,0x64,0x00,0x31,0x04,0x00,

0x04,0x48,0x45,0x4C,0x4C,

0x01, 0x08, 0x82,0x84,0x8b,0x96,0x0c,0x18,0x30,0x48,
0x03,0x01,0x05,0x05,0x04,0x00,0x01,0x00,0x00,0x2a,
0x01,0x00,0x32,0x04,0x12,0x24,0x60,0x6c,0x30,0x14,
0x01,0x00,0x00,0x0f,0xac,0x04,0x01,0x00,0x00,0x0f,
0xac,0x04,0x01,0x00,0x00,0x0f,0xac,0x02,0x01,0x00
 */

